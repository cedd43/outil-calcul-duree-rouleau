
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calcul Durée Rouleau</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0b0b">
<link rel="apple-touch-icon" href="logo-192.png">

<style>
:root{
    --bg-overlay: 0.45;
    --card-bg: 0.92;
    --success: #28a745;
    --primary: #007bff;
    --start: #2e7d32;
    --start-hover: #1b5e20;
}
html, body { height: 100%; }
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#0b0b0b;
    background-image:
        linear-gradient(rgba(0,0,0,var(--bg-overlay)), rgba(0,0,0,var(--bg-overlay))),
        url('bg-pem.jpg');
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    background-attachment:fixed;
    padding:20px;
}
.container{
    max-width:560px;margin:0 auto;
    background:rgba(255,255,255,var(--card-bg));
    padding:22px;border-radius:10px;
    box-shadow:0 10px 28px rgba(0,0,0,0.35);
    backdrop-filter:blur(2px);
}
h1{
    text-align:center;color:white;
    text-shadow:0 2px 6px rgba(0,0,0,0.6);
}
label{display:block;margin-top:10px;color:#222}
input,select{
    width:100%;padding:8px;margin-top:5px;
    border-radius:6px;border:1px solid #cfd4dc;
}
button{
    padding:11px;width:100%;border:none;
    border-radius:6px;color:white;font-weight:bold;
    cursor:pointer;margin-top:14px;
}
.btn-primary{background:var(--primary);}
.btn-primary:hover{background:#0056b3;}
.btn-start{background:var(--start);font-size:1.05rem;}
.btn-start:hover{background:var(--start-hover);}
.btn-reset{background:#6c757d;}
.btn-reset:hover{background:#555;}

.result{margin-top:12px;font-weight:bold;}
.result.success{color:var(--success);}
.error{color:#d93025;font-weight:bold;}

.section{display:none;}
.sub-section{
    margin-top:28px;padding-top:14px;
    border-top:1px solid rgba(0,0,0,0.12);
}
.sub-section h3{margin-bottom:10px;color:var(--primary);}

.time-block{
    margin-top:12px;padding:12px;
    background:rgba(0,0,0,0.05);
    border-radius:6px;
}
.time-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.time-inline label{margin-top:0;}
.countdown{margin-top:8px;font-weight:bold;color:#333;}

.help-note{
    margin-top:12px;font-size:12px;color:#444;
}

.footer{
    margin:24px auto 0;
    width:fit-content;
    color:white;font-size:14px;font-weight:bold;
    background:rgba(0,0,0,0.4);
    padding:8px 12px;border-radius:6px;
    text-shadow:0 2px 6px rgba(0,0,0,0.7);
}
</style>
</head>

<body>
<h1>Calcul Durée Rouleau</h1>

<div class="container">
    <label>Choisissez le type :</label>
    <select id="typeChoix" onchange="toggleSections()">
        <option value="">-- Sélectionnez --</option>
        <option value="feuillard">Feuillard</option>
        <option value="pieces">Pièces découpées</option>
    </select>

    <!-- ------- FEUILLARD -------- -->
    <div id="sectionFeuillard" class="section">
        <h2>Feuillard</h2>

        <label>Poids du rouleau (kg):</label>
        <input type="number" id="poidsRouleau" step="10">

        <label>Poids par mètre (g/m):</label>
        <input type="number" id="poidsMetre" step="1">

        <label>Vitesse (m/h):</label>
        <input type="number" id="vitesseFeuillard" step="5">

        <button class="btn-primary" onclick="calculFeuillard()">Calculer la durée</button>
        <div class="result" id="resultFeuillard"></div>

        <div id="timeFeuillard" class="time-block" style="display:none;">
            <div class="time-inline">
                <label>Heure de début :</label>
                <input type="time" id="startTimeFeuillard">
            </div>

            <button class="btn-start" onclick="departMaintenant('feuillard')">Départ rouleau</button>

            <div class="countdown" id="countdownFeuillard"></div>
            <div class="result" id="endTimeFeuillard"></div>
        </div>
    </div>

    <!-- ------- PIECES -------- -->
    <div id="sectionPieces" class="section">
        <h2>Pièces découpées</h2>

        <label>Nombre total de pièces :</label>
        <input type="number" id="nbPieces" step="1000">

        <label>Nombre de pièces par pas :</label>
        <input type="number" id="piecesParPas" step="1" value="1">

        <label>Taille du pas (mm) :</label>
        <input type="number" id="taillePas" step="1">

        <label>Vitesse (m/h) :</label>
        <input type="number" id="vitessePieces" step="5">

        <button class="btn-primary" onclick="calculPieces()">Calculer la durée</button>
        <div class="result" id="resultPieces"></div>

        <div id="timePieces" class="time-block" style="display:none;">
            <div class="time-inline">
                <label>Heure de début :</label>
                <input type="time" id="startTimePieces">
            </div>

            <button class="btn-start" onclick="departMaintenant('pieces')">Départ bobine</button>

            <div class="countdown" id="countdownPieces"></div>
            <div class="result" id="endTimePieces"></div>
        </div>
    </div>

    <button class="btn-reset" onclick="resetAll()">Réinitialiser</button>

    <p class="help-note">
        Pour une utilisation optimale sur téléphone :<br>
        • <b>Android (Chrome)</b> → Installer l'app (Ajouter à l’écran d’accueil)<br>
        • <b>iPhone (Safari)</b> → Partager → <b>Sur l’écran d’accueil</b><br>
        Puis gardez l'application <b>ouverte</b> pour que le minuteur fonctionne.
    </p>

    <div class="footer">outil libre d'accès – C.Duffner – AST PEM – V1.9 – 16/01/26</div>
</div>

<script>
/* =====================================================
    VARIABLES
===================================================== */
let timers = {
    feuillard: {end:null, durationMin:null, interval:null},
    pieces:    {end:null, durationMin:null, interval:null}
};

/* =====================================================
    SAUVEGARDE LOCALSTORAGE
===================================================== */
function saveState(){
    const state = {
        inputs:{
            poidsRouleau: document.getElementById('poidsRouleau').value,
            poidsMetre: document.getElementById('poidsMetre').value,
            vitesseFeuillard: document.getElementById('vitesseFeuillard').value,
            nbPieces: document.getElementById('nbPieces').value,
            piecesParPas: document.getElementById('piecesParPas').value,
            taillePas: document.getElementById('taillePas').value,
            vitessePieces: document.getElementById('vitessePieces').value,
            startTimeFeuillard: document.getElementById('startTimeFeuillard').value,
            startTimePieces: document.getElementById('startTimePieces').value
        },
        timers:{
            feuillard: timers.feuillard,
            pieces: timers.pieces
        }
    };
    localStorage.setItem("outilDuree", JSON.stringify(state));
}

function loadState(){
    const raw = localStorage.getItem("outilDuree");
    if(!raw) return;
    const st = JSON.parse(raw);

    // restaurer champs
    Object.keys(st.inputs).forEach(id => {
        if(document.getElementById(id))
            document.getElementById(id).value = st.inputs[id];
    });

    // restaurer timers
    timers = st.timers;

    // relancer timers si encore valides
    const now = new Date();
    for(const k of ['feuillard','pieces']){
        if(timers[k].end){
            const end = new Date(timers[k].end);
            if(end > now){  // encore valide
                timers[k].end = end;
                showTimerBlock(k);
                startCountdown(k, end);
            }else{
                // terminé
                timers[k].end = null;
            }
        }
    }
}

/* =====================================================
    AFFICHAGE DES SECTIONS
===================================================== */
function toggleSections(){
    const c = document.getElementById('typeChoix').value;
    document.getElementById('sectionFeuillard').style.display = c==='feuillard'?'block':'none';
    document.getElementById('sectionPieces').style.display = c==='pieces'?'block':'none';
}

/* =====================================================
    UTILS
===================================================== */
function pad2(n){return n.toString().padStart(2,'0');}
function nowHHMM(){
    const d=new Date();
    return pad2(d.getHours())+":"+pad2(d.getMinutes());
}
function parseTimeToDate(hhmm){
    const [h,m]=hhmm.split(':').map(x=>parseInt(x));
    const d=new Date();
    d.setHours(h,m,0,0);
    return d;
}
function addMin(date,min){
    return new Date(date.getTime()+min*60000);
}
function formatHHMM(d){
    return pad2(d.getHours())+":"+pad2(d.getMinutes());
}

/* =====================================================
    TIMER
===================================================== */
function startCountdown(type, end){
    clearInterval(timers[type].interval);
    timers[type].end = end;

    const el = document.getElementById(
        type==='feuillard'?'countdownFeuillard':'countdownPieces'
    );

    function tick(){
        const now = new Date();
        const diff = Math.max(0, end-now);
        const m = Math.floor(diff/60000);
        const s = Math.floor((diff%60000)/1000);
        el.textContent = `Temps restant : ${pad2(m)} min ${pad2(s)} s`;
        if(diff<=0){
            clearInterval(timers[type].interval);
            el.textContent="Terminé.";
        }
        saveState();
    }
    tick();
    timers[type].interval = setInterval(tick,1000);
}

function showTimerBlock(type){
    document.getElementById(
        type==='feuillard'?'timeFeuillard':'timePieces'
    ).style.display='block';
}

/* =====================================================
    DEPART MANUEL & AUTO
===================================================== */
function departMaintenant(type){
    if(type==='feuillard'){
        document.getElementById('startTimeFeuillard').value = nowHHMM();
        validerHeure('feuillard');
    }else{
        document.getElementById('startTimePieces').value = nowHHMM();
        validerHeure('pieces');
    }
}

function validerHeure(type){
    if(!timers[type].durationMin){
        alert("Calculez d’abord la durée.");
        return;
    }
    const inp = document.getElementById(
        type==='feuillard'?'startTimeFeuillard':'startTimePieces'
    );
    if(!inp.value){ alert("Heure de début manquante"); return; }

    const start = parseTimeToDate(inp.value);
    const end = addMin(start, timers[type].durationMin);

    const out = document.getElementById(
        type==='feuillard'?'endTimeFeuillard':'endTimePieces'
    );
    out.textContent = 
       (type==='feuillard' ? "Si le rouleau" : "Si la bobine") +
       " commence à "+formatHHMM(start)+", elle terminera à "+formatHHMM(end)+".";

    showTimerBlock(type);
    startCountdown(type, end);
    saveState();
}

/* =====================================================
    CALCUL FEUILLARD
===================================================== */
function calculFeuillard(){
    const pm = parseFloat(document.getElementById('poidsMetre').value);
    const pr = parseFloat(document.getElementById('poidsRouleau').value);
    const v  = parseFloat(document.getElementById('vitesseFeuillard').value);
    const out= document.getElementById('resultFeuillard');

    if(pm>0 && pr>0 && v>0){
        const kgpm = pm/1000;
        const dureeH = pr/(kgpm*v);
        const minTotal = Math.round(dureeH*60);

        timers.feuillard.durationMin = minTotal;

        out.className="result success";
        out.textContent = "Durée : " + Math.floor(minTotal/60)+" h "+(minTotal%60)+" min";

        document.getElementById('startTimeFeuillard').value = nowHHMM();
        previewFin("feuillard");

        document.getElementById('startTimeFeuillard').oninput = ()=>validerHeure('feuillard');
        document.getElementById('timeFeuillard').style.display='block';

        saveState();
    }else{
        out.className="result error";
        out.textContent="Veuillez remplir correctement tous les champs.";
    }
}

/* =====================================================
    CALCUL PIECES
===================================================== */
function calculPieces(){
    const nb = parseFloat(document.getElementById('nbPieces').value);
    const ppp= parseFloat(document.getElementById('piecesParPas').value);
    const tm = parseFloat(document.getElementById('taillePas').value);
    const v  = parseFloat(document.getElementById('vitessePieces').value);
    const out= document.getElementById('resultPieces');

    if(nb>0 && ppp>0 && tm>0 && v>0){
        const tmM = tm/1000;
        const dureeH = (nb*tmM)/(ppp*v);
        const minTotal = Math.round(dureeH*60);

        timers.pieces.durationMin = minTotal;

        out.className="result success";
        out.textContent = "Durée : " + Math.floor(minTotal/60)+" h "+(minTotal%60)+" min";

        document.getElementById('startTimePieces').value = nowHHMM();
        previewFin("pieces");

        document.getElementById('startTimePieces').oninput = ()=>validerHeure('pieces');
        document.getElementById('timePieces').style.display='block';

        saveState();
    }else{
        out.className="result error";
        out.textContent="Veuillez remplir correctement tous les champs.";
    }
}

/* =====================================================
    PREVIEW heure de fin sans démarrer timer
===================================================== */
function previewFin(type){
    const dur = timers[type].durationMin;
    if(!dur) return;

    const inp = document.getElementById(
        type==='feuillard'?'startTimeFeuillard':'startTimePieces'
    );
    if(!inp.value) return;

    const start=parseTimeToDate(inp.value);
    const end=addMin(start,dur);

    const out=document.getElementById(
        type==='feuillard'?'endTimeFeuillard':'endTimePieces'
    );
    out.textContent = 
        (type==='feuillard'?"Si le rouleau":"Si la bobine")+
        " commence à "+formatHHMM(start)+", elle terminera à "+formatHHMM(end)+".";

    // arrêter ancien timer si relance preview
    clearInterval(timers[type].interval);
    document.getElementById(
        type==='feuillard'?'countdownFeuillard':'countdownPieces'
    ).textContent="";
}

/* =====================================================
    RESET
===================================================== */
function resetAll(){
    localStorage.removeItem("outilDuree");
    location.reload();
}

/* =====================================================
    RESTAURATION AU LANCEMENT
===================================================== */
window.onload = loadState;

/* =====================================================
    SW REGISTRATION
===================================================== */
if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js');
}

</script>
</body>
</html>
