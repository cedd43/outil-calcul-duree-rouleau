
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcul Durée Rouleau</title>

  <!-- PWA (corrigé : plus de texte brut) -->
  <link rel="manifest" href="manifest.webmanifest?v=10">
  <link rel="apple-touch-icon" href="logo-192.png">

  <meta name="theme-color" content="#0b0b0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg-overlay: 0.45;
      --card-bg: 0.92;
      --success: #28a745;
      --primary: #007bff;
      --start: #2e7d32;
      --start-hover: #1b5e20;
      --text-dark: #222;
    }

    html, body{ height:100%; }

    body{
      margin:0;
      font-family:Arial, sans-serif;
      background:#0b0b0b;
      background-image:
        linear-gradient(rgba(0,0,0,var(--bg-overlay)), rgba(0,0,0,var(--bg-overlay))),
        url('bg-pem.jpg');
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      padding:20px;
    }

    h1{
      text-align:center;
      color:white;
      text-shadow:0 2px 6px rgba(0,0,0,0.6);
      margin-bottom:20px;
    }

    .container{
      max-width:560px;
      margin:0 auto;
      background:rgba(255,255,255,var(--card-bg));
      padding:22px;
      border-radius:10px;
      box-shadow:0 10px 28px rgba(0,0,0,0.35);
      backdrop-filter:blur(2px);
    }

    h2{
      margin-top:10px;
      color:var(--text-dark);
      border-left:5px solid var(--primary);
      padding-left:8px;
    }

    label{
      display:block;
      margin-top:12px;
      color:var(--text-dark);
      font-weight:bold;
    }

    input,select{
      width:100%;
      padding:10px;
      margin-top:5px;
      border-radius:6px;
      border:1px solid #cfd4dc;
      font-size:15px;
    }

    input::placeholder{ color:#999; font-style:italic; }

    button{
      padding:12px;
      width:100%;
      border:none;
      border-radius:6px;
      color:white;
      font-weight:bold;
      cursor:pointer;
      margin-top:16px;
      font-size:1.05em;
    }
    .btn-primary{ background:var(--primary); }
    .btn-primary:hover{ background:#0056b3; }
    .btn-start{ background:var(--start); }
    .btn-start:hover{ background:var(--start-hover); }
    .btn-reset{
      background:#6c757d;
      margin-top:25px;
    }
    .btn-reset:hover{ background:#555; }

    .result{ margin-top:14px; font-weight:bold; font-size:1.05em; }
    .success{ color:var(--success); }
    .error{ color:#d93025; }

    .info-box{
      margin-top:12px;
      background:#eef3fa;
      border:1px solid #d6dde7;
      padding:10px;
      border-radius:6px;
      font-weight:bold;
      color:#0b3d66;
      display:none;
    }

    .footer{
      margin:24px auto 0;
      width:fit-content;
      color:white;
      font-size:14px;
      font-weight:bold;
      background:rgba(0,0,0,0.4);
      padding:8px 12px;
      border-radius:6px;
      text-shadow:0 2px 6px rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>

<h1>Calcul Durée Rouleau</h1>

<div class="container">

  <!-- SÉLECTION TYPE -->
  <label>Choisissez le type :</label>
  <select id="typeChoix" onchange="onTypeChange()">
    <option value="">-- Sélectionnez --</option>
    <option value="feuillard">Feuillard</option>
    <option value="pieces">Pièces découpées</option>
  </select>

  <!-- FEUILLARD -->
  <div id="sectionFeuillard" style="display:none;">
    <h2>Feuillard</h2>

    <label>Poids du rouleau (kg) :</label>
    <input type="number" id="poidsRouleau" placeholder="ex : 1200" step="50"
           oninput="saveState(); updateLongueurFeuillard(); updateFin('feuillard')">

    <label>Poids par mètre (g/m) :</label>
    <input type="number" id="poidsMetre" placeholder="ex : 150" step="1"
           oninput="saveState(); updateLongueurFeuillard(); updateFin('feuillard')">

    <div id="longueurFeuillard" class="info-box"></div>

    <label>Vitesse (m/h) :</label>
    <input type="number" id="vitesseFeuillard" placeholder="ex : 200" step="10"
           oninput="saveState(); updateFin('feuillard')">

    <button class="btn-primary" onclick="calculFeuillard()">Calculer la durée</button>
    <div id="resultFeuillard" class="result"></div>

    <label style="margin-top:15px;">Heure de début :</label>
    <input type="time" id="startTimeFeuillard"
           oninput="saveState(); updateFin('feuillard')">
    <button class="btn-start" onclick="setStartNow('feuillard')">Définir l'heure actuelle</button>

    <div id="endTimeFeuillard" class="result"></div>
  </div>

  <!-- PIÈCES DÉCOUPÉES -->
  <div id="sectionPieces" style="display:none;">
    <h2>Pièces découpées</h2>

    <label>Nombre total de pièces :</label>
    <input type="number" id="nbPieces" placeholder="ex : 35000" step="1000"
           oninput="saveState(); updateLongueurPieces(); updateFin('pieces')">

    <label>Pièces par pas :</label>
    <input type="number" id="piecesParPas" placeholder="ex : 1" step="1" value="1"
           oninput="saveState(); updateLongueurPieces(); updateFin('pieces')">

    <label>Taille du pas (mm) :</label>
    <input type="number" id="taillePas" placeholder="ex : 24" step="1"
           oninput="saveState(); updateLongueurPieces(); updateFin('pieces')">

    <div id="longueurPieces" class="info-box"></div>

    <label>Vitesse (m/h) :</label>
    <input type="number" id="vitessePieces" placeholder="ex : 180" step="10"
           oninput="saveState(); updateFin('pieces')">

    <button class="btn-primary" onclick="calculPieces()">Calculer la durée</button>
    <div id="resultPieces" class="result"></div>

    <label style="margin-top:15px;">Heure de début :</label>
    <input type="time" id="startTimePieces"
           oninput="saveState(); updateFin('pieces')">
    <button class="btn-start" onclick="setStartNow('pieces')">Définir l'heure actuelle</button>

    <div id="endTimePieces" class="result"></div>
  </div>

  <button class="btn-reset" onclick="resetAll()">Réinitialiser</button>

</div>

<div class="footer">
  outil libre d'accès – C.Duffner – AST PEM – V3.1 – 19/01/26
</div>

<script>
/* -------------------------------
   UTILS
--------------------------------*/
const $ = (id) => document.getElementById(id);
function pad2(n){ return n.toString().padStart(2,"0"); }
function nowHHMM(){ const d=new Date(); return pad2(d.getHours())+":"+pad2(d.getMinutes()); }
function timeToDate(hhmm){
  const [h,m] = (hhmm||"").split(":").map(Number);
  const d = new Date();
  d.setHours(h||0, m||0, 0, 0);
  return d;
}
function addMin(dt,m){ return new Date(dt.getTime()+m*60000); }
function fmt(dt){ return pad2(dt.getHours())+":"+pad2(dt.getMinutes()); }

/* -------------------------------
   SAUVEGARDE
--------------------------------*/
function saveState(){
  const s = {
    type: $("typeChoix").value,
    poidsRouleau: $("poidsRouleau").value,
    poidsMetre: $("poidsMetre").value,
    vitesseFeuillard: $("vitesseFeuillard").value,
    nbPieces: $("nbPieces").value,
    piecesParPas: $("piecesParPas").value,
    taillePas: $("taillePas").value,
    vitessePieces: $("vitessePieces").value,
    startF: $("startTimeFeuillard").value,
    startP: $("startTimePieces").value
  };
  localStorage.setItem("outilDuree_3_1", JSON.stringify(s));
}

function loadState(){
  const raw = localStorage.getItem("outilDuree_3_1");
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    $("typeChoix").value       = s.type || "";
    $("poidsRouleau").value    = s.poidsRouleau || "";
    $("poidsMetre").value      = s.poidsMetre || "";
    $("vitesseFeuillard").value= s.vitesseFeuillard || "";
    $("nbPieces").value        = s.nbPieces || "";
    $("piecesParPas").value    = s.piecesParPas || "1";
    $("taillePas").value       = s.taillePas || "";
    $("vitessePieces").value   = s.vitessePieces || "";
    $("startTimeFeuillard").value = s.startF || "";
    $("startTimePieces").value    = s.startP || "";
  }catch(e){}
}

/* -------------------------------
   AFFICHAGE SECTIONS
--------------------------------*/
function onTypeChange(){
  $("sectionFeuillard").style.display = "none";
  $("sectionPieces").style.display = "none";
  if($("typeChoix").value==="feuillard") $("sectionFeuillard").style.display="block";
  if($("typeChoix").value==="pieces") $("sectionPieces").style.display="block";
  saveState();
}

/* -------------------------------
   LONGUEURS
--------------------------------*/
function formatMeters(m){
  return (m>=100 ? Math.round(m) : Math.round(m*10)/10).toString().replace(".",",");
}

function updateLongueurFeuillard(){
  const pr = parseFloat($("poidsRouleau").value);
  const pm = parseFloat($("poidsMetre").value);
  const box = $("longueurFeuillard");
  if(pr>0 && pm>0){
    const m = (pr*1000)/pm;
    box.textContent = "Rouleau de " + formatMeters(m) + " m";
    box.style.display = "block";
  } else {
    box.textContent = "";
    box.style.display = "none";
  }
}

function updateLongueurPieces(){
  const nb = parseFloat($("nbPieces").value);
  const ppp= parseFloat($("piecesParPas").value);
  const tp = parseFloat($("taillePas").value);
  const box = $("longueurPieces");
  if(nb>0 && ppp>0 && tp>0){
    const m = (nb/ppp)*(tp/1000);
    box.textContent = "Bobine de " + formatMeters(m) + " m";
    box.style.display = "block";
  } else {
    box.textContent = "";
    box.style.display = "none";
  }
}

/* -------------------------------
   CALCULS
--------------------------------*/
let durees = { feuillard:null, pieces:null };

function calculFeuillard(){
  const pm = parseFloat($("poidsMetre").value);     // g/m
  const pr = parseFloat($("poidsRouleau").value);   // kg
  const v  = parseFloat($("vitesseFeuillard").value); // m/h
  const out = $("resultFeuillard");

  if(pm>0 && pr>0 && v>0){
    const h = pr / ((pm/1000)*v);
    const min = Math.round(h*60);
    durees.feuillard = min;

    out.className = "result success";
    out.textContent = `Durée : ${Math.floor(min/60)} h ${min%60} min`;

    // Met à jour la phrase de fin si une heure existe
    updateFin("feuillard");
    saveState();
  } else {
    durees.feuillard = null;
    out.className = "result error";
    out.textContent = "Champs incorrects.";
    $("endTimeFeuillard").textContent = "";
  }
}

function calculPieces(){
  const nb = parseFloat($("nbPieces").value);
  const ppp= parseFloat($("piecesParPas").value);
  const tp = parseFloat($("taillePas").value); // mm
  const v  = parseFloat($("vitessePieces").value); // m/h
  const out= $("resultPieces");

  if(nb>0 && ppp>0 && tp>0 && v>0){
    const h = (nb*(tp/1000))/(ppp*v);
    const min = Math.round(h*60);
    durees.pieces = min;

    out.className = "result success";
    out.textContent = `Durée : ${Math.floor(min/60)} h ${min%60} min`;

    updateFin("pieces");
    saveState();
  } else {
    durees.pieces = null;
    out.className = "result error";
    out.textContent = "Champs incorrects.";
    $("endTimePieces").textContent = "";
  }
}

/* -------------------------------
   HEURE DE FIN (pas de timer)
--------------------------------*/
function updateFin(t){
  const dur = (t==="feuillard" ? durees.feuillard : durees.pieces);
  if(!dur) return;

  const inId  = (t==="feuillard" ? "startTimeFeuillard" : "startTimePieces");
  const outId = (t==="feuillard" ? "endTimeFeuillard"  : "endTimePieces");

  const startVal = $(inId).value;
  if(!startVal){
    $(outId).textContent = "";
    return;
  }

  const start = timeToDate(startVal);
  const end   = addMin(start, dur);
  const sujet = (t==="feuillard" ? "le rouleau" : "la bobine");
  const pronom= (t==="feuillard" ? "il" : "elle");

  $(outId).textContent = `Si ${sujet} commence à ${fmt(start)}, ${pronom} terminera à ${fmt(end)}.`;
}

function setStartNow(t){
  const id = (t==="feuillard" ? "startTimeFeuillard" : "startTimePieces");
  $(id).value = nowHHMM();
  updateFin(t);
  saveState();
}

/* -------------------------------
   RESET
--------------------------------*/
function resetAll(){
  localStorage.removeItem("outilDuree_3_1");

  // vider champs
  ["poidsRouleau","poidsMetre","vitesseFeuillard",
   "nbPieces","piecesParPas","taillePas","vitessePieces",
   "startTimeFeuillard","startTimePieces"].forEach(id=>$(id).value="");

  // restaurer valeur par défaut de pièces par pas
  $("piecesParPas").value = "1";

  // nettoyer affichages
  ["resultFeuillard","resultPieces","endTimeFeuillard","endTimePieces"].forEach(id=>$(id).textContent="");
  $("longueurFeuillard").style.display="none";
  $("longueurPieces").style.display="none";

  // sections
  $("typeChoix").value="";
  $("sectionFeuillard").style.display="none";
  $("sectionPieces").style.display="none";

  // réafficher placeholders (déjà gérés par HTML)
}

/* -------------------------------
   INIT
--------------------------------*/
window.addEventListener("load", ()=>{
  loadState();          // recharge valeurs sauvegardées si présentes
  onTypeChange();       // affiche la bonne section
  updateLongueurFeuillard();
  updateLongueurPieces();
  updateFin("feuillard");
  updateFin("pieces");
});
</script>

<!-- Service Worker : on garde ta version (change le ?v=13 → ?v=15 pour forcer une MAJ) -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', async () => {
    try{
      const reg = await navigator.serviceWorker.register('./sw.js?v=17');
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing; if(!nw) return;
        nw.addEventListener('statechange', () => {
          if(nw.state==='installed' && navigator.serviceWorker.controller){
            if(reg.waiting) reg.waiting.postMessage({ type:'SKIP_WAITING' });
          }
        });
      });
      let refreshing=false;
      navigator.serviceWorker.addEventListener('controllerchange',()=>{ if(refreshing) return; refreshing=true; location.reload(); });
      if(reg.update) reg.update();
    }catch(e){ console.error('SW registration failed', e); }
  });
}
</script>

</body>
</html>
