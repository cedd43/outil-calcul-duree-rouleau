
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calcul Durée Rouleau</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest?v=3">
<link rel="apple-touch-icon" href="logo-192.png">
<meta name="theme-color" content="#0b0b0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
    --bg-overlay: 0.45;
    --card-bg: 0.92;
    --success: #28a745;
    --primary: #007bff;
    --start: #2e7d32;
    --start-hover: #1b5e20;
}
html, body { height: 100%; }
body{
    margin:0; font-family:Arial, sans-serif; background:#0b0b0b;
    background-image:
        linear-gradient(rgba(0,0,0,var(--bg-overlay)), rgba(0,0,0,var(--bg-overlay))),
        url('bg-pem.jpg');
    background-size:cover; background-position:center; background-repeat:no-repeat; background-attachment:fixed;
    padding:20px;
}
.container{
    max-width:560px; margin:0 auto; background:rgba(255,255,255,var(--card-bg));
    padding:22px; border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,0.35); backdrop-filter:blur(2px);
}
h1{ text-align:center; color:white; text-shadow:0 2px 6px rgba(0,0,0,0.6); }
label{ display:block; margin-top:10px; color:#222 }
input,select{ width:100%; padding:8px; margin-top:5px; border-radius:6px; border:1px solid #cfd4dc; }
button{ padding:11px; width:100%; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer; margin-top:14px; }
.btn-primary{ background:var(--primary); } .btn-primary:hover{ background:#0056b3; }
.btn-start{ background:var(--start); font-size:1.05rem; } .btn-start:hover{ background:var(--start-hover); }
.btn-reset{ background:#6c757d; } .btn-reset:hover{ background:#555; }
.result{ margin-top:12px; font-weight:bold; }
.result.success{ color:var(--success); }
.error{ color:#d93025; font-weight:bold; }
.section{ display:none; }
.sub-section{ margin-top:28px; padding-top:14px; border-top:1px solid rgba(0,0,0,0.12); }
.sub-section h3{ margin-bottom:10px; color:var(--primary); }
.time-block{ margin-top:12px; padding:12px; background:rgba(0,0,0,0.05); border-radius:6px; }
.time-inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.countdown{ margin-top:8px; font-weight:bold; color:#333; }
.help-note{ margin-top:12px; font-size:12px; color:#444; }
.footer{ margin:24px auto 0; width:fit-content; color:white; font-size:14px; font-weight:bold; background:rgba(0,0,0,0.4); padding:8px 12px; border-radius:6px; text-shadow:0 2px 6px rgba(0,0,0,0.7); }
/* séparateur OU */
.or-sep { text-align:center; font-weight:700; color:#666; margin:8px 0 -4px; letter-spacing:.5px; }
.or-sep::before, .or-sep::after {
  content:""; display:inline-block; width:30%; height:1px; background:#bbb; vertical-align:middle; margin:0 8px;
}
</style>
</head>
<body>
<h1>Calcul Durée Rouleau</h1>
<div class="container">
    <label>Choisissez le type :</label>
    <select id="typeChoix" onchange="toggleSections()">
        <option value="">-- Sélectionnez --</option>
        <option value="feuillard">Feuillard</option>
        <option value="pieces">Pièces découpées</option>
    </select>

    <!-- FEUILLARD -->
    <div id="sectionFeuillard" class="section">
        <h2>Feuillard</h2>
        <label>Poids du rouleau (kg):</label>
        <input type="number" id="poidsRouleau" step="10">
        <label>Poids par mètre (g/m):</label>
        <input type="number" id="poidsMetre" step="1">
        <label>Vitesse (m/h):</label>
        <input type="number" id="vitesseFeuillard" step="5">

        <button class="btn-primary" onclick="calculFeuillard()">Calculer la durée</button>
        <div class="result" id="resultFeuillard"></div>

        <div id="timeFeuillard" class="time-block" style="display:none;">
          <div class="time-inline">
            <label><b>Choisir l'heure de début (du rouleau)</b> :</label>
            <input type="time" id="startTimeFeuillard">
          </div>

          <div class="or-sep">OU</div>
          <button class="btn-start" onclick="departMaintenant('feuillard')">Départ rouleau</button>

          <div class="countdown" id="countdownFeuillard"></div>
          <div class="result" id="endTimeFeuillard"></div>
        </div>
    </div>

    <!-- PIECES -->
    <div id="sectionPieces" class="section">
        <h2>Pièces découpées</h2>
        <label>Nombre total de pièces :</label>
        <input type="number" id="nbPieces" step="1000">
        <label>Nombre de pièces par pas :</label>
        <input type="number" id="piecesParPas" step="1" value="1">
        <label>Taille du pas (mm) :</label>
        <input type="number" id="taillePas" step="1">
        <label>Vitesse (m/h) :</label>
        <input type="number" id="vitessePieces" step="5">

        <button class="btn-primary" onclick="calculPieces()">Calculer la durée</button>
        <div class="result" id="resultPieces"></div>

        <div id="timePieces" class="time-block" style="display:none;">
          <div class="time-inline">
            <label><b>Choisir l'heure de début (de la bobine)</b> :</label>
            <input type="time" id="startTimePieces">
          </div>

          <div class="or-sep">OU</div>
          <button class="btn-start" onclick="departMaintenant('pieces')">Départ bobine</button>

          <div class="countdown" id="countdownPieces"></div>
          <div class="result" id="endTimePieces"></div>
        </div>
    </div>

    <button class="btn-reset" onclick="resetAll()">Réinitialiser</button>

    <!-- INFO PWA (sans la phrase à supprimer) -->
    <p class="help-note">
        Pour une utilisation sur téléphone :<br>
        • <b>Android (Chrome)</b> → Installer l'app (Ajouter à l’écran d’accueil)<br>
        • <b>iPhone (Safari)</b> → Partager → <b>Sur l’écran d’accueil</b>
    </p>

    <div class="footer">outil libre d'accès – C.Duffner – AST PEM – V2.0 – 16/01/26</div>
</div>

<script>
// =================== State =====================
let timers = {
    feuillard: {end:null, durationMin:null, interval:null},
    pieces:    {end:null, durationMin:null, interval:null}
};

// =================== Save/Load =================
function saveState(){
  const st = {
    inputs:{
      poidsRouleau: poidsRouleau.value,
      poidsMetre: poidsMetre.value,
      vitesseFeuillard: vitesseFeuillard.value,
      nbPieces: nbPieces.value,
      piecesParPas: piecesParPas.value,
      taillePas: taillePas.value,
      vitessePieces: vitessePieces.value,
      startTimeFeuillard: startTimeFeuillard.value,
      startTimePieces: startTimePieces.value
    },
    timers: timers
  };
  localStorage.setItem('outilDuree', JSON.stringify(st));
}
function loadState(){
  const raw = localStorage.getItem('outilDuree');
  if(!raw) return;
  const st = JSON.parse(raw);
  Object.keys(st.inputs).forEach(id=>{ if(document.getElementById(id)) document.getElementById(id).value = st.inputs[id]; });
  timers = st.timers;
  const now = new Date();
  for(const t of ['feuillard','pieces']){
    if(timers[t].end){
      timers[t].end = new Date(timers[t].end);
      if(timers[t].end > now){ showTimerBlock(t); startCountdown(t, timers[t].end); }
      else { timers[t].end = null; }
    }
  }
}

// =================== UI =====================
function toggleSections(){
  const c = typeChoix.value;
  sectionFeuillard.style.display = (c==='feuillard')?'block':'none';
  sectionPieces.style.display    = (c==='pieces')?'block':'none';
}
function pad2(n){ return n.toString().padStart(2,'0'); }
function nowHHMM(){ const d=new Date(); return pad2(d.getHours())+":"+pad2(d.getMinutes()); }
function parseTimeToDate(hhmm){ const [h,m]=hhmm.split(':').map(Number); const d=new Date(); d.setHours(h,m,0,0); return d; }
function addMin(date,min){ return new Date(date.getTime()+min*60000); }
function formatHHMM(d){ return pad2(d.getHours())+":"+pad2(d.getMinutes()); }

// =================== Timer =====================
function showTimerBlock(t){ document.getElementById(t==='feuillard'?'timeFeuillard':'timePieces').style.display='block'; }
function startCountdown(t, end){
  clearInterval(timers[t].interval);
  timers[t].end = end;
  const el = document.getElementById(t==='feuillard'?'countdownFeuillard':'countdownPieces');
  function tick(){
    const now = new Date();
    const diff = Math.max(0, end - now);
    const m = Math.floor(diff/60000);
    const s = Math.floor((diff%60000)/1000);
    el.textContent = `Temps restant : ${pad2(m)} min ${pad2(s)} s`;
    if(diff<=0){ clearInterval(timers[t].interval); el.textContent='Terminé.'; }
    saveState();
  }
  tick();
  timers[t].interval = setInterval(tick, 1000);
}

// départ immédiat : met l'heure actuelle puis démarre
function departMaintenant(t){
  const input = document.getElementById(t==='feuillard'?'startTimeFeuillard':'startTimePieces');
  input.value = nowHHMM();
  validerHeure(t);
}

// valider après saisie manuelle (relance timer)
function validerHeure(t){
  if(!timers[t].durationMin){ alert('Calculez d\'abord la durée.'); return; }
  const input = document.getElementById(t==='feuillard'?'startTimeFeuillard':'startTimePieces');
  if(!input.value){ alert('Heure de début manquante'); return; }
  const start = parseTimeToDate(input.value);
  const end = addMin(start, timers[t].durationMin);
  const out = document.getElementById(t==='feuillard'?'endTimeFeuillard':'endTimePieces');
  out.textContent = (t==='feuillard'? 'Si le rouleau':'Si la bobine') + ` commence à ${formatHHMM(start)}, elle terminera à ${formatHHMM(end)}.`;
  showTimerBlock(t); startCountdown(t, end);
}

// preview fin sans démarrer le timer
function previewFin(t){
  const dur = timers[t].durationMin; if(!dur) return;
  const input = document.getElementById(t==='feuillard'?'startTimeFeuillard':'startTimePieces');
  if(!input.value) return;
  const start = parseTimeToDate(input.value); const end = addMin(start, dur);
  const out = document.getElementById(t==='feuillard'?'endTimeFeuillard':'endTimePieces');
  out.textContent = (t==='feuillard'? 'Si le rouleau':'Si la bobine') + ` commence à ${formatHHMM(start)}, elle terminera à ${formatHHMM(end)}.`;
  clearInterval(timers[t].interval);
  document.getElementById(t==='feuillard'?'countdownFeuillard':'countdownPieces').textContent = '';
}

// =================== Calculs =====================
function calculFeuillard(){
  const pm = parseFloat(poidsMetre.value); const pr = parseFloat(poidsRouleau.value); const v = parseFloat(vitesseFeuillard.value);
  const out = resultFeuillard;
  if(pm>0 && pr>0 && v>0){
    const kgpm = pm/1000; const dureeH = pr/(kgpm*v); const minTotal = Math.round(dureeH*60);
    timers.feuillard.durationMin = minTotal;
    out.className = 'result success';
    out.textContent = `Durée : ${Math.floor(minTotal/60)} h ${minTotal%60} min`;
    startTimeFeuillard.value = nowHHMM(); previewFin('feuillard');
    startTimeFeuillard.oninput = ()=>validerHeure('feuillard');
    timeFeuillard.style.display='block'; saveState();
  }else{
    out.className='result error'; out.textContent='Champs incorrects.';
  }
}
function calculPieces(){
  const nb = parseFloat(nbPieces.value); const ppp = parseFloat(piecesParPas.value); const tm = parseFloat(taillePas.value); const v = parseFloat(vitessePieces.value);
  const out = resultPieces;
  if(nb>0 && ppp>0 && tm>0 && v>0){
    const tmM = tm/1000; const dureeH = (nb*tmM)/(ppp*v); const minTotal = Math.round(dureeH*60);
    timers.pieces.durationMin = minTotal;
    out.className = 'result success';
    out.textContent = `Durée : ${Math.floor(minTotal/60)} h ${minTotal%60} min`;
    startTimePieces.value = nowHHMM(); previewFin('pieces');
    startTimePieces.oninput = ()=>validerHeure('pieces');
    timePieces.style.display='block'; saveState();
  }else{
    out.className='result error'; out.textContent='Champs incorrects.';
  }
}

// =================== Reset =====================
function resetAll(){ localStorage.removeItem('outilDuree'); location.reload(); }

// init
window.addEventListener('load', loadState);

// SW
if('serviceWorker' in navigator){
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js?v=3');
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing; if(!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
      let refreshing=false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if(refreshing) return; refreshing=true; location.reload();
      });
      if (reg && reg.update) reg.update();
    } catch(e){ console.error('SW registration failed', e); }
  });
}
</script>
</body>
</html>
