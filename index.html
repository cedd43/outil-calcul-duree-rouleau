
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calcul Durée Rouleau</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest?v=10">
  <link rel="apple-touch-icon" href="logo-192.png">
  <meta name="theme-color" content="#0b0b0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg-overlay: 0.45;
      --card-bg: 0.92;
      --success: #28a745;
      --primary: #007bff;
      --start: #2e7d32;
      --start-hover: #1b5e20;
    }
    html, body { height: 100%; }
    body{
      margin:0; font-family:Arial, sans-serif; background:#0b0b0b;
      background-image:
        linear-gradient(rgba(0,0,0,var(--bg-overlay)), rgba(0,0,0,var(--bg-overlay))),
        url('bg-pem.jpg');
      background-size:cover; background-position:center; background-repeat:no-repeat; background-attachment:fixed;
      padding:20px;
    }
    /* Carte principale */
    .container{
      max-width:560px; margin:0 auto; background:rgba(255,255,255,var(--card-bg));
      padding:22px; border-radius:10px;
      box-shadow:0 10px 28px rgba(0,0,0,0.35);
      backdrop-filter:blur(2px);
    }
    h1{
      text-align:center; color:white;
      text-shadow:0 2px 6px rgba(0,0,0,0.6);
    }
    h2{ margin:12px 0 6px; }
    label{ display:block; margin-top:10px; color:#222 }
    input,select{
      width:100%; padding:8px; margin-top:5px;
      border-radius:6px; border:1px solid #cfd4dc;
    }
    input::placeholder { color:#999; font-style:italic; }
    button{
      padding:11px; width:100%; border:none; border-radius:6px;
      color:white; font-weight:bold; cursor:pointer; margin-top:14px;
    }
    .btn-primary{ background:var(--primary); }
    .btn-primary:hover{ background:#0056b3; }
    .btn-start{ background:var(--start); font-size:1.05rem; }
    .btn-start:hover{ background:var(--start-hover); }
    .btn-reset{ background:#6c757d; }
    .btn-reset:hover{ background:#555; }

    .result{ margin-top:12px; font-weight:bold; }
    .error{ color:#d93025; font-weight:bold; }
    .result.success{ color:var(--success); }
    .section{ display:none; }

    .inline-time { display:flex; gap:10px; align-items: center; }
    .inline-time > * { flex: 1 1 auto; }
    .inline-time label{ margin: 0; }
    .note{ font-size:12px; color:#444; margin-top:8px; }
    .info-line{
      margin:8px 0 0;
      padding:8px 10px;
      background:#f3f6fb;
      border:1px solid #dbe2ea;
      border-radius:6px;
      font-weight:600;
      color:#0d3b66;
    }

    /* Footer */
    .footer{
      margin:24px auto 0; width:fit-content;
      color:white; font-size:14px; font-weight:bold;
      background:rgba(0,0,0,0.4);
      padding:8px 12px;
      border-radius:6px;
      text-shadow:0 2px 6px rgba(0,0,0,0.7);
    }

    /* Responsive */
    @media (min-width: 900px){
      .container{ max-width:560px; }
    }
    @media (max-width: 480px){
      .container{ margin: 0 4px; }
    }
  </style>
</head>
<body>
  <h1>Calcul Durée Rouleau</h1>

  <div class="container" id="mainContainer">
    <!-- Sélecteur -->
    <label>Choisissez le type :</label>
    <select id="typeChoix" onchange="onTypeChange()">
      <option value="">-- Sélectionnez --</option>
      <option value="feuillard">Feuillard</option>
      <option value="pieces">Pièces découpées</option>
    </select>

    <!-- FEUILLARD -->
    <div id="sectionFeuillard" class="section">
      <h2>Feuillard</h2>

      <label>Poids du rouleau (kg):</label>
      <input type="number" id="poidsRouleau" placeholder="ex : 1200" step="10" oninput="updateLongueurFeuillard(); saveState();" />

      <label>Poids par mètre (g/m):</label>
      <input type="number" id="poidsMetre" placeholder="ex : 150" step="1" oninput="updateLongueurFeuillard(); saveState();" />

      <!-- Phrase longueur du rouleau -->
      <div id="longueurFeuillard" class="info-line" style="display:none;"></div>

      <label>Vitesse (m/h):</label>
      <input type="number" id="vitesseFeuillard" placeholder="ex : 200" step="5" oninput="saveState();" />

      <button class="btn-primary" onclick="calculFeuillard()">Calculer la durée</button>
      <div class="result" id="resultFeuillard"></div>

      <!-- Bloc heure début / fin (pas de timer) -->
      <div id="timeFeuillard" style="display:none;">
        <div class="inline-time" style="margin-top:10px;">
          <label><b>Heure de début (du rouleau)</b> :</label>
          <input type="time" id="startTimeFeuillard" oninput="validerHeure('feuillard'); saveState();" />
        </div>
        <button class="btn-start" onclick="setStartNow('feuillard')">Définir l'heure de début = maintenant</button>
        <div class="result" id="endTimeFeuillard"></div>
      </div>
    </div>

    <!-- PIECES -->
    <div id="sectionPieces" class="section">
      <h2>Pièces découpées</h2>

      <label>Nombre total de pièces :</label>
      <input type="number" id="nbPieces" placeholder="ex : 35000" step="1000" oninput="updateLongueurPieces(); saveState();" />

      <label>Nombre de pièces par pas :</label>
      <input type="number" id="piecesParPas" placeholder="ex : 1" step="1" oninput="updateLongueurPieces(); saveState();" />

      <label>Taille du pas (mm) :</label>
      <input type="number" id="taillePas" placeholder="ex : 24" step="1" oninput="updateLongueurPieces(); saveState();" />

      <!-- Phrase longueur de la bobine -->
      <div id="longueurPieces" class="info-line" style="display:none;"></div>

      <label>Vitesse (m/h) :</label>
      <input type="number" id="vitessePieces" placeholder="ex : 180" step="5" oninput="saveState();" />

      <button class="btn-primary" onclick="calculPieces()">Calculer la durée</button>
      <div class="result" id="resultPieces"></div>

      <!-- Bloc heure début / fin (pas de timer) -->
      <div id="timePieces" style="display:none;">
        <div class="inline-time" style="margin-top:10px;">
          <label><b>Heure de début (de la bobine)</b> :</label>
          <input type="time" id="startTimePieces" oninput="validerHeure('pieces'); saveState();" />
        </div>
        <button class="btn-start" onclick="setStartNow('pieces')">Définir l'heure de début = maintenant</button>
        <div class="result" id="endTimePieces"></div>
      </div>
    </div>

    <button class="btn-reset" onclick="resetAll()">Réinitialiser</button>
    <p class="note">
      Pour une utilisation sur téléphone :<br>
      • <b>Android (Chrome)</b> → Installer l'app (Ajouter à l’écran d’accueil)<br>
      • <b>iPhone (Safari)</b> → Partager → <b>Sur l’écran d’accueil</b>
    </p>
  </div>

  <div class="footer">outil libre d'accès – C.Duffner – AST PEM – V3.0 – 19/01/26</div>

  <script>
    // ===========================
    // PERSISTENCE (inputs only)
    // ===========================
    function saveState(){
      const inputs = {
        typeChoix: val('typeChoix'),
        poidsRouleau: val('poidsRouleau'),
        poidsMetre: val('poidsMetre'),
        vitesseFeuillard: val('vitesseFeuillard'),
        nbPieces: val('nbPieces'),
        piecesParPas: val('piecesParPas'),
        taillePas: val('taillePas'),
        vitessePieces: val('vitessePieces'),
        startTimeFeuillard: val('startTimeFeuillard'),
        startTimePieces: val('startTimePieces')
      };
      localStorage.setItem('outilDuree_inputs', JSON.stringify(inputs));
    }

    function loadState(){
      const raw = localStorage.getItem('outilDuree_inputs');
      if(!raw) return;
      try{
        const st = JSON.parse(raw);
        Object.keys(st).forEach(id => {
          if(document.getElementById(id) !== null){
            document.getElementById(id).value = st[id];
          }
        });
      }catch(e){ /* ignore */ }
    }

    // ===========================
    // UTILS
    // ===========================
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function nowHHMM(){ const d=new Date(); return pad2(d.getHours())+":"+pad2(d.getMinutes()); }
    function parseTimeToDate(hhmm){
      const [h,m]=hhmm.split(':').map(Number);
      const d=new Date(); d.setHours(h||0,m||0,0,0); return d;
    }
    function addMin(date,min){ return new Date(date.getTime()+min*60000); }
    function formatHHMM(d){ return pad2(d.getHours())+":"+pad2(d.getMinutes()); }
    function val(id){ const el=document.getElementById(id); return el?el.value:""; }
    function show(id){ const el=document.getElementById(id); if(el) el.style.display='block'; }
    function hide(id){ const el=document.getElementById(id); if(el) el.style.display='none'; }

    // ===========================
    // ÉTATS (durées calculées)
    // ===========================
    const durees = { feuillard:null, pieces:null }; // minutes

    // ===========================
    // NAV / SECTIONS
    // ===========================
    function hideAllSections(){
      document.getElementById('sectionFeuillard').style.display='none';
      document.getElementById('sectionPieces').style.display='none';
    }
    function onTypeChange(){
      const type = document.getElementById('typeChoix').value;
      hideAllSections();
      if(type==='feuillard'){
        document.getElementById('sectionFeuillard').style.display='block';
      }else if(type==='pieces'){
        document.getElementById('sectionPieces').style.display='block';
      }
      saveState();
    }

    // ===========================
    // LONGUEUR instantanée (preview)
    // ===========================
    function updateLongueurFeuillard(){
      const pr = parseFloat((val('poidsRouleau')||'').replace(',', '.'));
      const pm = parseFloat((val('poidsMetre')||'').replace(',', '.'));
      const box = document.getElementById('longueurFeuillard');

      if(pr>0 && pm>0){
        const longueurM = (pr * 1000) / pm; // m
        box.textContent = `Rouleau de ${formatMeters(longueurM)} m`;
        box.style.display = 'block';
      }else{
        box.style.display = 'none';
      }
    }

    function updateLongueurPieces(){
      const nb  = parseFloat((val('nbPieces')||'').replace(',', '.'));
      const ppp = parseFloat((val('piecesParPas')||'').replace(',', '.'));
      const tp  = parseFloat((val('taillePas')||'').replace(',', '.'));
      const box = document.getElementById('longueurPieces');

      if(nb>0 && ppp>0 && tp>0){
        const longueurM = (nb/ppp) * (tp/1000); // m
        box.textContent = `Bobine de ${formatMeters(longueurM)} m`;
        box.style.display = 'block';
      }else{
        box.style.display = 'none';
      }
    }

    function formatMeters(m){
      // Affiche sans décimales au-dessus de 100 m, sinon 1 décimale
      if(m >= 100) return Math.round(m).toString();
      return (Math.round(m*10)/10).toString().replace('.', ',');
    }

    // ===========================
    // CALCULS
    // ===========================
    function calculFeuillard(){
      const pm = parseFloat((val('poidsMetre')||'').replace(',', '.'));      // g/m
      const pr = parseFloat((val('poidsRouleau')||'').replace(',', '.'));    // kg
      const v  = parseFloat((val('vitesseFeuillard')||'').replace(',', '.'));// m/h
      const out= document.getElementById('resultFeuillard');

      if(pm>0 && pr>0 && v>0){
        const kgpm = pm/1000;                   // kg/m
        const dureeH = pr/(kgpm*v);             // heures
        const minTotal = Math.round(dureeH*60); // minutes

        durees.feuillard = minTotal;
        out.className='result success';
        out.textContent = `Durée : ${Math.floor(minTotal/60)} h ${minTotal%60} min`;

        // afficher bloc heure et calcul de fin si heure déjà présente
        show('timeFeuillard');
        if(val('startTimeFeuillard')) validerHeure('feuillard');
        saveState();
      }else{
        durees.feuillard = null;
        out.className='result error';
        out.textContent = 'Champs incorrects.';
        hide('timeFeuillard');
      }
    }

    function calculPieces(){
      const nb  = parseFloat((val('nbPieces')||'').replace(',', '.'));
      const ppp = parseFloat((val('piecesParPas')||'').replace(',', '.'));
      const tm  = parseFloat((val('taillePas')||'').replace(',', '.'));      // mm
      const v   = parseFloat((val('vitessePieces')||'').replace(',', '.'));  // m/h
      const out = document.getElementById('resultPieces');

      if(nb>0 && ppp>0 && tm>0 && v>0){
        const tmM = tm/1000;                     // m
        const dureeH = (nb*tmM)/(ppp*v);         // heures
        const minTotal = Math.round(dureeH*60);  // minutes

        durees.pieces = minTotal;
        out.className='result success';
        out.textContent = `Durée : ${Math.floor(minTotal/60)} h ${minTotal%60} min`;

        // afficher bloc heure et calcul de fin si heure déjà présente
        show('timePieces');
        if(val('startTimePieces')) validerHeure('pieces');
        saveState();
      }else{
        durees.pieces = null;
        out.className='result error';
        out.textContent = 'Champs incorrects.';
        hide('timePieces');
      }
    }

    // ===========================
    // HEURES (pas de timer)
    // ===========================
    function setStartNow(t){
      const id = (t==='feuillard' ? 'startTimeFeuillard' : 'startTimePieces');
      const input = document.getElementById(id);
      input.value = nowHHMM();
      validerHeure(t);
      saveState();
    }

    function validerHeure(t){
      const hasDur = (t==='feuillard' ? durees.feuillard : durees.pieces);
      if(!hasDur){ alert("Calculez d'abord la durée."); return; }

      const idIn   = (t==='feuillard' ? 'startTimeFeuillard' : 'startTimePieces');
      const idOut  = (t==='feuillard' ? 'endTimeFeuillard'  : 'endTimePieces');
      const startVal = val(idIn);
      if(!startVal){ document.getElementById(idOut).textContent = ""; return; }

      const start = parseTimeToDate(startVal);
      const end = addMin(start, hasDur);
      const sujet = (t === 'feuillard') ? 'le rouleau' : 'la bobine';
      const pronom = (t === 'feuillard') ? 'il' : 'elle';

      document.getElementById(idOut).textContent =
        `Si ${sujet} commence à ${formatHHMM(start)}, ${pronom} terminera à ${formatHHMM(end)}.`;
    }

    // ===========================
    // RESET
    // ===========================
    function resetAll(){
      localStorage.removeItem('outilDuree_inputs');
      hideAllSections();
      document.getElementById('typeChoix').value="";
      // Clear champs
      [
        'poidsRouleau','poidsMetre','vitesseFeuillard',
        'nbPieces','piecesParPas','taillePas','vitessePieces',
        'startTimeFeuillard','startTimePieces',
        'resultFeuillard','resultPieces','endTimeFeuillard','endTimePieces',
        'longueurFeuillard','longueurPieces'
      ].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(el.tagName==='INPUT') el.value='';
        else { el.textContent=''; el.style.display='none'; }
      });
      durees.feuillard = null;
      durees.pieces = null;
      hide('timeFeuillard');
      hide('timePieces');
    }

    // ===========================
    // INIT
    // ===========================
    window.addEventListener('load', ()=>{
      loadState();
      // Affiche la bonne section si un type a été mémorisé
      onTypeChange();
      // Rafraîchit les info-lines "longueur"
      updateLongueurFeuillard();
      updateLongueurPieces();

      // Si des heures de début étaient mémorisées et que la durée a été (re)calculée ensuite,
      // l'utilisateur pourra recliquer "Calculer" pour réafficher le bloc heure.
    });
  </script>

  <!-- SW (inchangé) -->
  <script>
    // SW v12/v13 (selon votre fichier sw.js)
    if('serviceWorker' in navigator){
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('./sw.js?v=13');
          reg.addEventListener('updatefound', () => {
            const nw = reg.installing; if(!nw) return;
            nw.addEventListener('statechange', () => {
              if(nw.state==='installed' && navigator.serviceWorker.controller)
                if(reg.waiting) reg.waiting.postMessage({ type:'SKIP_WAITING' });
            });
          });
          let refreshing=false;
          navigator.serviceWorker.addEventListener('controllerchange',()=>{ if(refreshing) return; refreshing=true; location.reload(); });
          if(reg.update) reg.update();
        } catch(e){
          console.error("SW registration failed",e);
        }
      });
    }
  </script>
</body>
</html>
``
